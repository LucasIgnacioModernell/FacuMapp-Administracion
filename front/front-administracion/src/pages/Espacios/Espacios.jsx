import { useEffect, useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { API_URL } from "../../config";
import "./EspaciosMap.scss";

const ZONES = [
  { id: "1", x: 49, y: 912, w: 48, h: 26, r: 6 },
  { id: "2", x: 49, y: 941, w: 48, h: 31, r: 6 },
  { id: "3", x: 49, y: 975, w: 48, h: 34, r: 6 },
  { id: "4", x: 49, y: 1012, w: 48, h: 26, r: 6 },
  { id: "5", x: 49, y: 1041, w: 48, h: 77, r: 8 },
  { id: "6", x: 100, y: 1075, w: 40, h: 43, r: 8 },
  { id: "7", x: 159, y: 1099, w: 59, h: 24, r: 6 },
  { id: "8", x: 159, y: 1075, w: 59, h: 21, r: 6 },
  { id: "9", x: 143, y: 1019, w: 66, h: 32, r: 8 },
  { id: "10", x: 143, y: 976, w: 74, h: 40, r: 8 },
  { id: "11", x: 143, y: 928, w: 74, h: 45, r: 8 },
  { id: "12", x: 143, y: 881, w: 74, h: 44, r: 8 },
  { id: "13", x: 143, y: 802, w: 75, h: 44, r: 6 },
  { id: "14", type: "custom", d: "M264 846H221V799H199V761H264V846Z" },
  { id: "15", x: 267, y: 796, w: 45, h: 50, r: 6 },
  { id: "16", x: 267, y: 761, w: 45, h: 32, r: 6 },
  { id: "17", x: 49, y: 751, w: 48, h: 72, r: 8 },
  { id: "18", x: 103, y: 624, w: 69, h: 46, r: 6 },
  { id: "19", x: 199, y: 630, w: 84, h: 95, r: 8 },
  { id: "20", x: 286, y: 702, w: 43, h: 23, r: 6 },
  { id: "21", x: 332, y: 702, w: 30, h: 23, r: 6 },
  { id: "22", x: 365, y: 702, w: 30, h: 23, r: 6 },
  { id: "23", x: 309, y: 556, w: 93, h: 120, r: 8 },
  { id: "24", x: 452, y: 680, w: 55, h: 45, r: 6 },
  { id: "25", x: 452, y: 584, w: 55, h: 93, r: 6 },
  { id: "26", x: 452, y: 536, w: 55, h: 45, r: 6 },
  { id: "27", x: 309, y: 313, w: 93, h: 240, r: 10 },
  { id: "28", x: 452, y: 471, w: 84, h: 62, r: 6 },
  { id: "29", x: 452, y: 413, w: 84, h: 55, r: 6 },
  { id: "30", x: 452, y: 354, w: 84, h: 56, r: 6 },
  { id: "31", x: 452, y: 295, w: 84, h: 56, r: 6 },
  { id: "32", x: 452, y: 237, w: 84, h: 55, r: 6 },
  { id: "33", x: 452, y: 178, w: 84, h: 56, r: 6 },
  { id: "34", x: 452, y: 121, w: 84, h: 54, r: 6 },
  { id: "35", x: 428, y: 3, w: 108, h: 115, r: 10 },
];

export default function Espacios() {
  const [espacios, setEspacios] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [hoveredZone, setHoveredZone] = useState(null);

  const navigate = useNavigate();


  const COLORS = {
    paredes: "#2b2f3a",
    zonaDefault: "#e5e7eb",
    zonaStroke: "#d1d5db",
    zonaHover: "#667eea",
  };
  const [currentPage, setCurrentPage] = useState(1);
  const ITEMS_PER_PAGE = 6;


  const fetchEspacios = async () => {
    try {
      const response = await fetch(`${API_URL}/espacio`);
      if (!response.ok) throw new Error("Error al obtener los espacios");
      const data = await response.json();
      setEspacios(data);
    } catch (error) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchEspacios();
  }, []);

  const filteredEspacios = espacios.filter(
    (esp) =>
      esp.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
      esp.descripcion.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const totalPages = Math.ceil(filteredEspacios.length / ITEMS_PER_PAGE);

  const paginatedEspacios = filteredEspacios.slice(
    (currentPage - 1) * ITEMS_PER_PAGE,
    currentPage * ITEMS_PER_PAGE
  );


  const handleZoneClick = (zoneId) => {
    navigate(`/edit-espacio/${zoneId}`);
  };

  if (loading) return <div className="text-center py-5">Cargando...</div>;
  if (error) return <div className="alert alert-danger">{error}</div>;

  return (
    <div className="page-container">
      <div className="page-header mb-4">
        <h1>
          <i className="bi bi-building me-2"></i> Gestión de Espacios
        </h1>
      </div>

      <div className="row">
        <div className="col-12 mb-3">
          <input
            type="text"
            className="form-control form-control-custom"
            placeholder="Buscar espacios..."
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1);
            }}
          />
        </div>
        <div className="col-lg-7 mb-4">
          <div className="grid-container">
            {paginatedEspacios.map((esp) => {
              const imageUrl = esp.imagen ? `${API_URL}/${esp.imagen}` : null;
              return (
                <div key={esp.id} className="custom-card">
                  <div className="space-card-image">
                    <img
                      src={imageUrl || "/images/no-image.png"}
                      alt={esp.nombre}
                      onError={(e) => {
                        e.target.onerror = null;
                        e.target.src = "https://placehold.co/600x400?text=Sin+Imagen";
                      }}
                    />
                  </div>
                  <div className="card-body">
                    <h5 className="card-title">{esp.nombre}</h5>
                    <p className="card-text">
                      {esp.descripcion || "Sin descripción disponible."}
                    </p>
                    {esp.categorias && esp.categorias.length > 0 && (
                      <div className="mb-2 d-flex flex-wrap gap-2">
                        {esp.categorias.slice(0, 3).map((cat) => (
                          <span
                            key={cat.id}
                            className="badge badge-custom"
                            style={{ backgroundColor: cat.color || undefined }}
                          >
                            {cat.nombre}
                          </span>
                        ))}
                        {esp.categorias.length > 3 && (
                          <span className="badge bg-secondary">
                            +{esp.categorias.length - 3}
                          </span>
                        )}
                      </div>
                    )}
                    <div className="card-capacity">
                      <i className="bi bi-people-fill"></i>
                      Capacidad: {esp.capacidad} personas
                    </div>
                    <Link
                      to={`/edit-espacio/${esp.id}`}
                      className="btn btn-edit"
                    >
                      Editar
                    </Link>
                  </div>
                </div>
              );
            })}
          </div>
          {totalPages > 1 && (
            <div className="pagination-futuristic">
              <button
                className="pagination-btn prev"
                disabled={currentPage === 1}
                onClick={() => setCurrentPage((p) => p - 1)}
              >
                <i className="bi bi-chevron-left"></i>
                <span>Anterior</span>
              </button>

              <div className="pagination-indicator">
                {currentPage} / {totalPages}
              </div>

              <button
                className="pagination-btn next"
                disabled={currentPage === totalPages}
                onClick={() => setCurrentPage((p) => p + 1)}
              >
                <span>Siguiente</span>
                <i className="bi bi-chevron-right"></i>
              </button>

            </div>
          )}
        </div>

        <div className="col-lg-5">
          <div className="card p-3 border-0">
            <h5 className="mb-3 text-center text-muted">Mapa Interactivo</h5>
            <div className="map-container">
              <svg
                width="100%"
                viewBox="0 0 539 1126"
                xmlns="http://www.w3.org/2000/svg"
                className="interactive-map-svg"
              >
                <g id="Group 1">
                  {ZONES.map((zone) => {
                    const espacioData = espacios.find(
                      (e) => String(e.id) === zone.id
                    );
                    const title = espacioData
                      ? espacioData.nombre
                      : `Espacio ID ${zone.id}`;

                    const isHovered = hoveredZone === zone.id;
                    const fillColor = isHovered ? COLORS.zonaHover : COLORS.zonaDefault;

                    const commonProps = {
                      key: zone.id,
                      id: `zone-${zone.id}`,
                      fill: fillColor,
                      stroke: COLORS.zonaStroke,
                      strokeWidth: 2,
                      style: { cursor: 'pointer', transition: 'fill 0.2s ease' },
                      onMouseEnter: () => setHoveredZone(zone.id),
                      onMouseLeave: () => setHoveredZone(null),
                      onClick: () => handleZoneClick(zone.id),
                      className: "map-zone"
                    };

                    if (zone.type === "custom") {
                      return (
                        <path {...commonProps} d={zone.d}>
                          <title>{title}</title>
                        </path>
                      );
                    }

                    return (
                      <rect
                        {...commonProps}
                        x={zone.x}
                        y={zone.y}
                        width={zone.w}
                        height={zone.h}
                        rx={zone.r}
                      >
                        <title>{title}</title>
                      </rect>
                    );
                  })}

                  <path
                    id="paredes"
                    d="M98.5 741C99.3284 741 100 741.672 100 742.5V749.5C100 750.328 99.3284 751 98.5 751H49V823H97V762.5C97 761.672 97.6716 761 98.5 761C99.3284 761 100 761.672 100 762.5V847.5C100 848.328 99.3284 849 98.5 849H57V886H98.5C99.3284 886 100 886.672 100 887.5V910.5C100 911.328 99.3284 912 98.5 912H49V938H97V923.5C97 922.672 97.6716 922 98.5 922C99.3284 922 100 922.672 100 923.5V939.5C100 940.328 99.3284 941 98.5 941H49V972H97V952.5C97 951.672 97.6716 951 98.5 951C99.3284 951 100 951.672 100 952.5V973.5C100 974.328 99.3284 975 98.5 975H49V1009H97V986.5C97 985.672 97.6716 985 98.5 985C99.3284 985 100 985.672 100 986.5V1010.5C100 1011.33 99.3284 1012 98.5 1012H49V1038H97V1023.5C97 1022.67 97.6716 1022 98.5 1022C99.3284 1022 100 1022.67 100 1023.5V1039.5C100 1040.33 99.3284 1041 98.5 1041H49V1118H97V1086.5C97 1085.67 97.6716 1085 98.5 1085C99.3284 1085 100 1085.67 100 1086.5V1118H140V1074.91C139.418 1074.71 139 1074.15 139 1073.5C139 1072.85 139.418 1072.29 140 1072.09V1066.5C140 1065.67 140.672 1065 141.5 1065C142.328 1065 143 1065.67 143 1066.5V1118H156V1110.5C156 1109.67 156.672 1109 157.5 1109C158.328 1109 159 1109.67 159 1110.5V1123H218V1099H158.913C158.707 1099.58 158.153 1100 157.5 1100C156.672 1100 156 1099.33 156 1098.5V1086.5C156 1085.67 156.672 1085 157.5 1085C158.328 1085 159 1085.67 159 1086.5V1096H218V1075H158.913C158.707 1075.58 158.153 1076 157.5 1076C156.672 1076 156 1075.33 156 1074.5V1071.5C156 1070.67 156.672 1070 157.5 1070C158.328 1070 159 1070.67 159 1071.5V1072H183.087C183.293 1071.42 183.847 1071 184.5 1071C185.153 1071 185.707 1071.42 185.913 1072H209V1054H186V1062.5C186 1063.33 185.328 1064 184.5 1064C183.672 1064 183 1063.33 183 1062.5V1054H159V1059.5C159 1060.33 158.328 1061 157.5 1061C156.672 1061 156 1060.33 156 1059.5V1054H142.913C142.707 1054.58 142.153 1055 141.5 1055C140.823 1055 140.251 1054.55 140.064 1053.93C139.449 1053.75 139 1053.18 139 1052.5C139 1051.85 139.418 1051.29 140 1051.09V1045.5C140 1044.67 140.672 1044 141.5 1044C142.328 1044 143 1044.67 143 1045.5V1051H156V1047.5C156 1046.67 156.672 1046 157.5 1046C158.328 1046 159 1046.67 159 1047.5V1051H209V1019H155.5C154.672 1019 154 1018.33 154 1017.5C154 1016.67 154.672 1016 155.5 1016H217V976H143V993.5C143 994.328 142.328 995 141.5 995C140.672 995 140 994.328 140 993.5V958.5C140 957.672 140.672 957 141.5 957C142.328 957 143 957.672 143 958.5V973H217V928H143V945.5C143 946.328 142.328 947 141.5 947C140.672 947 140 946.328 140 945.5V906.5C140 905.672 140.672 905 141.5 905C142.328 905 143 905.672 143 906.5V925H217V881H205.5C204.672 881 204 880.328 204 879.5C204 878.672 204.672 878 205.5 878H208V849H141.5C140.672 849 140 848.328 140 847.5V800.5C140 799.672 140.672 799 141.5 799H184.5C185.328 799 186 799.672 186 800.5C186 801.328 185.328 802 184.5 802H143V846H218V802H197.5C196.672 802 196 801.328 196 800.5C196 799.672 196.672 799 197.5 799H219.5C220.328 799 221 799.672 221 800.5V846H264V760.912C263.843 760.968 263.676 761 263.5 761H199V787.5C199 788.328 198.328 789 197.5 789C196.672 789 196 788.328 196 787.5V759.5C196 758.672 196.672 758 197.5 758H263.5C263.885 758 264.235 758.146 264.5 758.384C264.765 758.146 265.115 758 265.5 758C266.328 758 267 758.672 267 759.5V793H312V761H278.5C277.672 761 277 760.328 277 759.5C277 758.672 277.672 758 278.5 758H313.5C314.328 758 315 758.672 315 759.5V794.5C315 795.328 314.328 796 313.5 796H267V846H312V807.5C312 806.672 312.672 806 313.5 806C314.328 806 315 806.672 315 807.5V847.5C315 848.328 314.328 849 313.5 849H211V878H218.5C219.328 878 220 878.672 220 879.5V1017.5C220 1018.33 219.328 1019 218.5 1019H212V1072H219.5C220.328 1072 221 1072.67 221 1073.5V1124.5C221 1125.33 220.328 1126 219.5 1126H157.5C156.723 1126 156.085 1125.41 156.008 1124.65C156.003 1124.6 156 1124.55 156 1124.5V1121H47.5C47.4482 1121 47.3971 1121 47.3467 1120.99C46.6407 1120.92 46.0795 1120.36 46.0078 1119.65C46.0027 1119.6 46 1119.55 46 1119.5V910.5C46 909.672 46.6716 909 47.5 909H97V889H47.5C46.6716 889 46 888.328 46 887.5C46 886.672 46.6716 886 47.5 886H54V849H47.5C46.6716 849 46 848.328 46 847.5C46 846.672 46.6716 846 47.5 846H97V826H47.5C46.7233 826 46.0846 825.41 46.0078 824.653C46.0027 824.603 46 824.552 46 824.5V749.5C46 748.672 46.6716 748 47.5 748H97V742.5C97 741.672 97.6716 741 98.5 741ZM110.5 1051C111.328 1051 112 1051.67 112 1052.5C112 1053.33 111.328 1054 110.5 1054H100V1072H110.5C111.328 1072 112 1072.67 112 1073.5C112 1074.33 111.328 1075 110.5 1075H98.5C97.6716 1075 97 1074.33 97 1073.5V1052.5C97 1051.67 97.6716 1051 98.5 1051H110.5ZM128.5 1051C129.328 1051 130 1051.67 130 1052.5C130 1053.33 129.328 1054 128.5 1054H126V1072H128.5C129.328 1072 130 1072.67 130 1073.5C130 1074.33 129.328 1075 128.5 1075H122.5C121.672 1075 121 1074.33 121 1073.5C121 1072.67 121.672 1072 122.5 1072H123V1054H122.5C121.672 1054 121 1053.33 121 1052.5C121 1051.67 121.672 1051 122.5 1051H128.5ZM141.5 1005C142.328 1005 143 1005.67 143 1006.5V1016.09C143.582 1016.29 144 1016.85 144 1017.5C144 1018.15 143.582 1018.71 143 1018.91V1032.5C143 1033.33 142.328 1034 141.5 1034C140.672 1034 140 1033.33 140 1032.5V1006.5C140 1005.67 140.672 1005 141.5 1005ZM192.5 878C193.328 878 194 878.672 194 879.5C194 880.328 193.328 881 192.5 881H143V893.5C143 894.328 142.328 895 141.5 895C140.672 895 140 894.328 140 893.5V879.5C140 878.672 140.672 878 141.5 878H192.5ZM508.5 758C509.328 758 510 758.672 510 759.5C510 760.328 509.328 761 508.5 761H339V847.5C339 848.328 338.328 849 337.5 849C336.672 849 336 848.328 336 847.5V759.5C336 758.672 336.672 758 337.5 758H508.5ZM284.5 627C285.328 627 286 627.672 286 628.5V699H317.5C318.328 699 319 699.672 319 700.5C319 701.328 318.328 702 317.5 702H286V725H329V700.5C329 700.448 329.003 700.397 329.008 700.347C329.085 699.59 329.723 699 330.5 699H396.5C397.277 699 397.915 699.59 397.992 700.347C397.997 700.397 398 700.448 398 700.5V726.5C398 727.328 397.328 728 396.5 728H376.5C375.672 728 375 727.328 375 726.5C375 725.672 375.672 725 376.5 725H395V702H365V726.5C365 727.328 364.328 728 363.5 728C362.672 728 362 727.328 362 726.5V702H332V725H350.5C351.328 725 352 725.672 352 726.5C352 727.328 351.328 728 350.5 728H197.5C196.672 728 196 727.328 196 726.5C196 725.672 196.672 725 197.5 725H283V630H199V713.5C199 714.328 198.328 715 197.5 715C196.672 715 196 714.328 196 713.5V628.5C196 628.448 196.003 628.397 196.008 628.347C196.085 627.59 196.723 627 197.5 627H284.5ZM537.5 0C538.328 0 539 0.671573 539 1.5V534.5C539 535.328 538.328 536 537.5 536H510V726.5C510 726.552 509.997 726.603 509.992 726.653C509.921 727.359 509.359 727.921 508.653 727.992C508.603 727.997 508.552 728 508.5 728H450.5C449.672 728 449 727.328 449 726.5C449 725.672 449.672 725 450.5 725H507V680H452V713.5C452 714.328 451.328 715 450.5 715C449.672 715 449 714.328 449 713.5V678.5C449 677.672 449.672 677 450.5 677H507V584H452V617.5C452 618.328 451.328 619 450.5 619C449.672 619 449 618.328 449 617.5V582.5C449 581.672 449.672 581 450.5 581H507V536H452V569.5C452 570.328 451.328 571 450.5 571C449.672 571 449 570.328 449 569.5V534.5C449 533.672 449.672 533 450.5 533H536V471H452V521.5C452 522.328 451.328 523 450.5 523C449.672 523 449 522.328 449 521.5V469.5C449 469.448 449.003 469.397 449.008 469.347C449.085 468.59 449.723 468 450.5 468H536V413H452V457.5C452 458.328 451.328 459 450.5 459C449.672 459 449 458.328 449 457.5V411.5C449 411.448 449.003 411.397 449.008 411.347C449.085 410.59 449.723 410 450.5 410H536V354H452V398.5C452 399.328 451.328 400 450.5 400C449.672 400 449 399.328 449 398.5V352.5C449 351.672 449.672 351 450.5 351H536V295H452V339.5C452 340.328 451.328 341 450.5 341C449.672 341 449 340.328 449 339.5V293.5C449 292.672 449.672 292 450.5 292H536V237H463.5C462.672 237 462 236.328 462 235.5C462 234.672 462.672 234 463.5 234H536V178H452V222.5C452 223.328 451.328 224 450.5 224C449.672 224 449 223.328 449 222.5V176.5C449 175.672 449.672 175 450.5 175H536V121H452V163.5C452 164.328 451.328 165 450.5 165C449.672 165 449 164.328 449 163.5V121H445.5C444.672 121 444 120.328 444 119.5C444 118.672 444.672 118 445.5 118H536V3H428V118H431.5C432.328 118 433 118.672 433 119.5C433 120.328 432.328 121 431.5 121H428V726.5C428 727.277 427.41 727.915 426.653 727.992C426.603 727.997 426.552 728 426.5 728H409.5C408.672 728 408 727.328 408 726.5C408 725.672 408.672 725 409.5 725H425V1.5C425 0.671573 425.672 0 426.5 0H537.5ZM98.5 707C99.3284 707 100 707.672 100 708.5V723.5C100 724.328 99.3284 725 98.5 725C97.6716 725 97 724.328 97 723.5V710H1.5C0.671573 710 0 709.328 0 708.5C0 707.672 0.671573 707 1.5 707H98.5ZM356.5 271C357.328 271 358 271.672 358 272.5V310H363.5C364.328 310 365 310.672 365 311.5C365 312.328 364.328 313 363.5 313H356.5C355.672 313 355 312.328 355 311.5V274H309V310H343.5C344.328 310 345 310.672 345 311.5C345 312.328 344.328 313 343.5 313H309V553H403.5C404.328 553 405 553.672 405 554.5V677.5C405 678.328 404.328 679 403.5 679C402.672 679 402 678.328 402 677.5V556H309V676H390.5C391.328 676 392 676.672 392 677.5C392 678.328 391.328 679 390.5 679H307.5C306.672 679 306 678.328 306 677.5V272.5C306 271.672 306.672 271 307.5 271H356.5ZM173.5 621C174.328 621 175 621.672 175 622.5V671.5C175 672.328 174.328 673 173.5 673C172.672 673 172 672.328 172 671.5V624H103V670H160.5C161.328 670 162 670.672 162 671.5C162 672.328 161.328 673 160.5 673H1.5C0.671575 673 0 672.328 0 671.5C0 670.672 0.671573 670 1.5 670H100V622.5C100 622.448 100.003 622.397 100.008 622.347C100.085 621.59 100.723 621 101.5 621H173.5ZM450.5 629C451.328 629 452 629.672 452 630.5V665.5C452 666.328 451.328 667 450.5 667C449.672 667 449 666.328 449 665.5V630.5C449 629.672 449.672 629 450.5 629ZM403.5 310C404.328 310 405 310.672 405 311.5V531.5C405 532.328 404.328 533 403.5 533C402.672 533 402 532.328 402 531.5V313H393.5C392.672 313 392 312.328 392 311.5C392 310.672 392.672 310 393.5 310H403.5ZM450.5 234C451.328 234 452 234.672 452 235.5V280.5C452 281.328 451.328 282 450.5 282C449.672 282 449 281.328 449 280.5V235.5C449 234.672 449.672 234 450.5 234Z"
                    fill={COLORS.paredes}
                  />
                </g>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}